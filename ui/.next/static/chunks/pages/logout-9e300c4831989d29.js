(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[765],{1527:function(t,e,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/logout",function(){return r(9765)}])},1716:function(t,e,r){"use strict";r.d(e,{aC:function(){return s},c2:function(){return c}});var n=r(5893),o=r(7294);r(6441);var i=r(1163);let a=(0,o.createContext)(void 0),s=()=>{let t=(0,o.useContext)(a);if(void 0===t)throw Error("useAuth must be used within an AuthProvider");return t},c=t=>e=>{let{user:r,isLoading:a,hasAdminAccess:c}=s(),[l,u]=(0,o.useState)(!1),[h,d]=(0,o.useState)(!0),f=(0,i.useRouter)();return((0,o.useEffect)(()=>{let t=async()=>{if(r){let t=await c();u(t)}d(!1)};a||t()},[r,a,c]),(0,o.useEffect)(()=>{a||h||r&&l||f.push("/dashboard")},[r,l,a,h,f]),a||h)?(0,n.jsx)("div",{children:"Loading..."}):r&&l?(0,n.jsx)(t,{...e}):null}},6441:function(t,e,r){"use strict";r.d(e,{Pj:function(){return i}});var n=r(4155);let o={clientId:n.env.NEXT_PUBLIC_AZURE_CLIENT_ID||"",tenantId:n.env.NEXT_PUBLIC_AZURE_TENANT_ID||"common",redirectUri:n.env.NEXT_PUBLIC_AZURE_REDIRECT_URI||"".concat(window.location.origin,"/auth/callback/microsoft"),scopes:["openid","profile","email","User.Read"]},i=new class{async initializeSession(){try{let t=localStorage.getItem("opsgraph_token");if(t){let e=await this.validateToken(t);e?this.setCurrentUser(e):localStorage.removeItem("opsgraph_token")}}catch(t){console.error("Session initialization failed:",t)}}async validateToken(t){try{let e=await fetch("/api/auth/validate",{method:"GET",headers:{Authorization:"Bearer ".concat(t),"Content-Type":"application/json"}});if(e.ok)return await e.json();return null}catch(t){return console.error("Token validation failed:",t),null}}setCurrentUser(t){this.currentUser=t,this.authStateListeners.forEach(e=>e(t)),t&&this.setSessionContext(t.id)}async setSessionContext(t){try{await fetch("/api/auth/session-context",{method:"POST",headers:{Authorization:"Bearer ".concat(localStorage.getItem("opsgraph_token")),"Content-Type":"application/json"},body:JSON.stringify({userId:t})})}catch(t){console.error("Failed to set session context:",t)}}async signInWithMicrosoft(){try{let t=this.buildMicrosoftAuthUrl();return window.location.href=t,{user:null,error:null}}catch(t){return{user:null,error:t}}}buildMicrosoftAuthUrl(){let t=new URLSearchParams({client_id:o.clientId,response_type:"code",redirect_uri:o.redirectUri,scope:o.scopes.join(" "),response_mode:"query",state:crypto.randomUUID()});return"https://login.microsoftonline.com/".concat(o.tenantId,"/oauth2/v2.0/authorize?").concat(t)}async handleMicrosoftCallback(t,e){try{let r=await fetch("/api/auth/microsoft/callback",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:t,state:e})});if(!r.ok)throw Error("Microsoft login failed");let n=await r.json(),o=n.user;return localStorage.setItem("opsgraph_token",n.access_token),this.setCurrentUser(o),{user:o,error:null}}catch(t){return{user:null,error:t}}}async signInWithLocal(t,e){try{let r=await fetch("/api/auth/local/signin",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t,password:e})});if(!r.ok){let t=await r.json();throw Error(t.message||"Login failed")}let n=await r.json(),o=n.user;return localStorage.setItem("opsgraph_token",n.access_token),this.setCurrentUser(o),{user:o,error:null}}catch(t){return{user:null,error:t}}}async createLocalAccount(t){try{let e=await fetch("/api/auth/local/create",{method:"POST",headers:{Authorization:"Bearer ".concat(localStorage.getItem("opsgraph_token")),"Content-Type":"application/json"},body:JSON.stringify(t)});if(!e.ok){let t=await e.json();throw Error(t.message||"Account creation failed")}let r=await e.json();return{user:r.user,error:null}}catch(t){return{user:null,error:t}}}async signOut(){try{return await fetch("/api/auth/signout",{method:"POST",headers:{Authorization:"Bearer ".concat(localStorage.getItem("opsgraph_token")),"Content-Type":"application/json"}}),localStorage.removeItem("opsgraph_token"),this.setCurrentUser(null),{error:null}}catch(t){return localStorage.removeItem("opsgraph_token"),this.setCurrentUser(null),{error:t}}}async getUser(){return this.currentUser}async getProfile(t){var e;return(null===(e=this.currentUser)||void 0===e?void 0:e.profile)||null}async updateProfile(t,e){try{var r;let n=await fetch("/api/users/".concat(t,"/profile"),{method:"PATCH",headers:{Authorization:"Bearer ".concat(localStorage.getItem("opsgraph_token")),"Content-Type":"application/json"},body:JSON.stringify(e)});if(!n.ok)throw Error("Profile update failed");return(null===(r=this.currentUser)||void 0===r?void 0:r.profile)&&(this.currentUser.profile={...this.currentUser.profile,...e},this.setCurrentUser(this.currentUser)),{error:null}}catch(t){return{error:t}}}async getCurrentSession(){try{return{user:this.currentUser,error:null}}catch(t){return{user:null,error:t}}}onAuthStateChange(t){return this.authStateListeners.push(t),()=>{let e=this.authStateListeners.indexOf(t);e>-1&&this.authStateListeners.splice(e,1)}}async canAccessSite(t){var e;let r=null===(e=this.currentUser)||void 0===e?void 0:e.profile;return!!r&&(!!r.is_admin||"admin"===r.role||r.site_ids.includes(t))}async getUserSites(){var t;let e=null===(t=this.currentUser)||void 0===t?void 0:t.profile;return(null==e?void 0:e.site_ids)||[]}async hasAdminAccess(){var t;let e=null===(t=this.currentUser)||void 0===t?void 0:t.profile;return(null==e?void 0:e.is_admin)||(null==e?void 0:e.role)==="admin"||!1}async resetPassword(t){try{let e=await fetch("/api/auth/local/reset-password",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t})});if(!e.ok)throw Error("Password reset failed");return{error:null}}catch(t){return{error:t}}}async changePassword(t,e){try{let r=await fetch("/api/auth/local/change-password",{method:"POST",headers:{Authorization:"Bearer ".concat(localStorage.getItem("opsgraph_token")),"Content-Type":"application/json"},body:JSON.stringify({currentPassword:t,newPassword:e})});if(!r.ok)throw Error("Password change failed");return{error:null}}catch(t){return{error:t}}}constructor(){this.currentUser=null,this.authStateListeners=[],this.initializeSession()}}},9765:function(t,e,r){"use strict";r.r(e),r.d(e,{default:function(){return p}});var n=r(5893),o=r(7294),i=r(1163),a=r(7430),s=r(9381);let c=(0,a.m)("div",{baseStyle:{display:"flex",alignItems:"center",justifyContent:"center"}});c.displayName="Center";let l={horizontal:{insetStart:"50%",transform:"translateX(-50%)"},vertical:{top:"50%",transform:"translateY(-50%)"},both:{insetStart:"50%",top:"50%",transform:"translate(-50%, -50%)"}};(0,s.G)(function(t,e){let{axis:r="both",...o}=t;return(0,n.jsx)(a.m.div,{ref:e,__css:l[r],...o,position:"absolute"})});var u=r(8186),h=r(8899),d=r(92),f=r(1716),p=()=>{let t=(0,i.useRouter)(),{signOut:e}=(0,f.aC)();return(0,o.useEffect)(()=>{let r=async()=>{try{await e(),t.replace("/login")}catch(e){console.error("Logout error:",e),t.replace("/login")}};r()},[e,t]),(0,n.jsx)(c,{h:"100vh",bg:"gray.50",children:(0,n.jsxs)(u.g,{spacing:4,children:[(0,n.jsx)(h.$,{size:"lg",color:"brand.500",thickness:"4px"}),(0,n.jsx)(d.x,{color:"gray.600",children:"Signing you out..."})]})})}},1163:function(t,e,r){t.exports=r(6885)},4155:function(t){var e,r,n,o=t.exports={};function i(){throw Error("setTimeout has not been defined")}function a(){throw Error("clearTimeout has not been defined")}function s(t){if(e===setTimeout)return setTimeout(t,0);if((e===i||!e)&&setTimeout)return e=setTimeout,setTimeout(t,0);try{return e(t,0)}catch(r){try{return e.call(null,t,0)}catch(r){return e.call(this,t,0)}}}!function(){try{e="function"==typeof setTimeout?setTimeout:i}catch(t){e=i}try{r="function"==typeof clearTimeout?clearTimeout:a}catch(t){r=a}}();var c=[],l=!1,u=-1;function h(){l&&n&&(l=!1,n.length?c=n.concat(c):u=-1,c.length&&d())}function d(){if(!l){var t=s(h);l=!0;for(var e=c.length;e;){for(n=c,c=[];++u<e;)n&&n[u].run();u=-1,e=c.length}n=null,l=!1,function(t){if(r===clearTimeout)return clearTimeout(t);if((r===a||!r)&&clearTimeout)return r=clearTimeout,clearTimeout(t);try{r(t)}catch(e){try{return r.call(null,t)}catch(e){return r.call(this,t)}}}(t)}}function f(t,e){this.fun=t,this.array=e}function p(){}o.nextTick=function(t){var e=Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)e[r-1]=arguments[r];c.push(new f(t,e)),1!==c.length||l||s(d)},f.prototype.run=function(){this.fun.apply(null,this.array)},o.title="browser",o.browser=!0,o.env={},o.argv=[],o.version="",o.versions={},o.on=p,o.addListener=p,o.once=p,o.off=p,o.removeListener=p,o.removeAllListeners=p,o.emit=p,o.prependListener=p,o.prependOnceListener=p,o.listeners=function(t){return[]},o.binding=function(t){throw Error("process.binding is not supported")},o.cwd=function(){return"/"},o.chdir=function(t){throw Error("process.chdir is not supported")},o.umask=function(){return 0}},3712:function(t,e,r){"use strict";r.d(e,{K:function(){return h}});var n=r(5893),o=r(911),i=r(4926),a=r(7294),s=r(7430);let c=t=>(0,n.jsx)(s.m.div,{className:"chakra-stack__item",...t,__css:{display:"inline-block",flex:"0 0 auto",minWidth:0,...t.__css}});c.displayName="StackItem";var l=r(1185),u=r(9381);let h=(0,u.G)((t,e)=>{let{isInline:r,direction:u,align:h,justify:d,spacing:f="0.5rem",wrap:p,children:m,divider:y,className:g,shouldWrapChildren:v,..._}=t,w=r?"row":u??"column",T=(0,a.useMemo)(()=>(function(t){let{spacing:e,direction:r}=t,n={column:{my:e,mx:0,borderLeftWidth:0,borderBottomWidth:"1px"},"column-reverse":{my:e,mx:0,borderLeftWidth:0,borderBottomWidth:"1px"},row:{mx:e,my:0,borderLeftWidth:"1px",borderBottomWidth:0},"row-reverse":{mx:e,my:0,borderLeftWidth:"1px",borderBottomWidth:0}};return{"&":(0,l.XQ)(r,t=>n[t])}})({spacing:f,direction:w}),[f,w]),x=!!y,S=!v&&!x,k=(0,a.useMemo)(()=>{let t=(0,o.W)(m);return S?t:t.map((e,r)=>{let o=void 0!==e.key?e.key:r,i=r+1===t.length,s=(0,n.jsx)(c,{children:e},o),l=v?s:e;if(!x)return l;let u=(0,a.cloneElement)(y,{__css:T});return(0,n.jsxs)(a.Fragment,{children:[l,i?null:u]},o)})},[y,T,x,S,v,m]),b=(0,i.cx)("chakra-stack",g);return(0,n.jsx)(s.m.div,{ref:e,display:"flex",alignItems:h,justifyContent:d,flexDirection:w,flexWrap:p,gap:x?void 0:f,className:b,..._,children:k})});h.displayName="Stack"},8186:function(t,e,r){"use strict";r.d(e,{g:function(){return a}});var n=r(5893),o=r(3712),i=r(9381);let a=(0,i.G)((t,e)=>(0,n.jsx)(o.K,{align:"center",...t,direction:"column",ref:e}));a.displayName="VStack"},92:function(t,e,r){"use strict";r.d(e,{x:function(){return u}});var n=r(5893),o=r(5544),i=r(7155),a=r(4926),s=r(9381),c=r(9653),l=r(7430);let u=(0,s.G)(function(t,e){let r=(0,c.m)("Text",t),{className:s,align:u,decoration:h,casing:d,...f}=(0,o.L)(t),p=(0,i.o)({textAlign:t.align,textDecoration:t.decoration,textTransform:t.casing});return(0,n.jsx)(l.m.p,{ref:e,className:(0,a.cx)("chakra-text",t.className),...p,...f,__css:r})});u.displayName="Text"},911:function(t,e,r){"use strict";r.d(e,{W:function(){return o}});var n=r(7294);function o(t){return n.Children.toArray(t).filter(t=>(0,n.isValidElement)(t))}},1185:function(t,e,r){"use strict";r.d(e,{AV:function(){return o},XQ:function(){return i},Yq:function(){return a}});var n=r(9115);let o=Object.freeze(["base","sm","md","lg","xl","2xl"]);function i(t,e){return Array.isArray(t)?t.map(t=>null===t?null:e(t)):(0,n.Kn)(t)?Object.keys(t).reduce((r,n)=>(r[n]=e(t[n]),r),{}):null!=t?e(t):null}function a(t,e=o){let r={};return t.forEach((t,n)=>{let o=e[n];null!=t&&(r[o]=t)}),r}}},function(t){t.O(0,[774,888,179],function(){return t(t.s=1527)}),_N_E=t.O()}]);