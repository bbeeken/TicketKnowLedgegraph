(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[964],{577:function(e,r,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/admin",function(){return t(7159)}])},1716:function(e,r,t){"use strict";t.d(r,{aC:function(){return o},c2:function(){return l}});var s=t(5893),i=t(7294);t(6441);var n=t(1163);let a=(0,i.createContext)(void 0),o=()=>{let e=(0,i.useContext)(a);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e},l=e=>r=>{let{user:t,isLoading:a,hasAdminAccess:l}=o(),[c,d]=(0,i.useState)(!1),[h,u]=(0,i.useState)(!0),p=(0,n.useRouter)();return((0,i.useEffect)(()=>{let e=async()=>{if(t){let e=await l();d(e)}u(!1)};a||e()},[t,a,l]),(0,i.useEffect)(()=>{a||h||t&&c||p.push("/dashboard")},[t,c,a,h,p]),a||h)?(0,s.jsx)("div",{children:"Loading..."}):t&&c?(0,s.jsx)(e,{...r}):null}},6441:function(e,r,t){"use strict";t.d(r,{Pj:function(){return n}});var s=t(4155);let i={clientId:s.env.NEXT_PUBLIC_AZURE_CLIENT_ID||"",tenantId:s.env.NEXT_PUBLIC_AZURE_TENANT_ID||"common",redirectUri:s.env.NEXT_PUBLIC_AZURE_REDIRECT_URI||"".concat(window.location.origin,"/auth/callback/microsoft"),scopes:["openid","profile","email","User.Read"]},n=new class{async initializeSession(){try{let e=localStorage.getItem("opsgraph_token");if(e){let r=await this.validateToken(e);r?this.setCurrentUser(r):localStorage.removeItem("opsgraph_token")}}catch(e){console.error("Session initialization failed:",e)}}async validateToken(e){try{let r=await fetch("/api/auth/validate",{method:"GET",headers:{Authorization:"Bearer ".concat(e),"Content-Type":"application/json"}});if(r.ok)return await r.json();return null}catch(e){return console.error("Token validation failed:",e),null}}setCurrentUser(e){this.currentUser=e,this.authStateListeners.forEach(r=>r(e)),e&&this.setSessionContext(e.id)}async setSessionContext(e){try{await fetch("/api/auth/session-context",{method:"POST",headers:{Authorization:"Bearer ".concat(localStorage.getItem("opsgraph_token")),"Content-Type":"application/json"},body:JSON.stringify({userId:e})})}catch(e){console.error("Failed to set session context:",e)}}async signInWithMicrosoft(){try{let e=this.buildMicrosoftAuthUrl();return window.location.href=e,{user:null,error:null}}catch(e){return{user:null,error:e}}}buildMicrosoftAuthUrl(){let e=new URLSearchParams({client_id:i.clientId,response_type:"code",redirect_uri:i.redirectUri,scope:i.scopes.join(" "),response_mode:"query",state:crypto.randomUUID()});return"https://login.microsoftonline.com/".concat(i.tenantId,"/oauth2/v2.0/authorize?").concat(e)}async handleMicrosoftCallback(e,r){try{let t=await fetch("/api/auth/microsoft/callback",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:e,state:r})});if(!t.ok)throw Error("Microsoft login failed");let s=await t.json(),i=s.user;return localStorage.setItem("opsgraph_token",s.access_token),this.setCurrentUser(i),{user:i,error:null}}catch(e){return{user:null,error:e}}}async signInWithLocal(e,r){try{let t=await fetch("/api/auth/local/signin",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:r})});if(!t.ok){let e=await t.json();throw Error(e.message||"Login failed")}let s=await t.json(),i=s.user;return localStorage.setItem("opsgraph_token",s.access_token),this.setCurrentUser(i),{user:i,error:null}}catch(e){return{user:null,error:e}}}async createLocalAccount(e){try{let r=await fetch("/api/auth/local/create",{method:"POST",headers:{Authorization:"Bearer ".concat(localStorage.getItem("opsgraph_token")),"Content-Type":"application/json"},body:JSON.stringify(e)});if(!r.ok){let e=await r.json();throw Error(e.message||"Account creation failed")}let t=await r.json();return{user:t.user,error:null}}catch(e){return{user:null,error:e}}}async signOut(){try{return await fetch("/api/auth/signout",{method:"POST",headers:{Authorization:"Bearer ".concat(localStorage.getItem("opsgraph_token")),"Content-Type":"application/json"}}),localStorage.removeItem("opsgraph_token"),this.setCurrentUser(null),{error:null}}catch(e){return localStorage.removeItem("opsgraph_token"),this.setCurrentUser(null),{error:e}}}async getUser(){return this.currentUser}async getProfile(e){var r;return(null===(r=this.currentUser)||void 0===r?void 0:r.profile)||null}async updateProfile(e,r){try{var t;let s=await fetch("/api/users/".concat(e,"/profile"),{method:"PATCH",headers:{Authorization:"Bearer ".concat(localStorage.getItem("opsgraph_token")),"Content-Type":"application/json"},body:JSON.stringify(r)});if(!s.ok)throw Error("Profile update failed");return(null===(t=this.currentUser)||void 0===t?void 0:t.profile)&&(this.currentUser.profile={...this.currentUser.profile,...r},this.setCurrentUser(this.currentUser)),{error:null}}catch(e){return{error:e}}}async getCurrentSession(){try{return{user:this.currentUser,error:null}}catch(e){return{user:null,error:e}}}onAuthStateChange(e){return this.authStateListeners.push(e),()=>{let r=this.authStateListeners.indexOf(e);r>-1&&this.authStateListeners.splice(r,1)}}async canAccessSite(e){var r;let t=null===(r=this.currentUser)||void 0===r?void 0:r.profile;return!!t&&(!!t.is_admin||"admin"===t.role||t.site_ids.includes(e))}async getUserSites(){var e;let r=null===(e=this.currentUser)||void 0===e?void 0:e.profile;return(null==r?void 0:r.site_ids)||[]}async hasAdminAccess(){var e;let r=null===(e=this.currentUser)||void 0===e?void 0:e.profile;return(null==r?void 0:r.is_admin)||(null==r?void 0:r.role)==="admin"||!1}async resetPassword(e){try{let r=await fetch("/api/auth/local/reset-password",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e})});if(!r.ok)throw Error("Password reset failed");return{error:null}}catch(e){return{error:e}}}async changePassword(e,r){try{let t=await fetch("/api/auth/local/change-password",{method:"POST",headers:{Authorization:"Bearer ".concat(localStorage.getItem("opsgraph_token")),"Content-Type":"application/json"},body:JSON.stringify({currentPassword:e,newPassword:r})});if(!t.ok)throw Error("Password change failed");return{error:null}}catch(e){return{error:e}}}constructor(){this.currentUser=null,this.authStateListeners=[],this.initializeSession()}}},7159:function(e,r,t){"use strict";t.r(r),t.d(r,{default:function(){return Y}});var s=t(5893),i=t(7294),n=t(9345),a=t(1046),o=t(6254),l=t(8186),c=t(3636),d=t(8029),h=t(232),u=t(92),p=t(8491),m=t(6657),f=t(8843),g=t(8663),x=t(8779),j=t(8455),_=t(4703),v=t(1901),S=t(7167),w=t(4476),y=t(6007),C=t(3416),T=t(4032),U=t(608),b=t(2095),P=t(2519),I=t(4302),k=t(7293),A=t(5490),E=t(4614),N=t(2158),z=t(7391),R=t(1360),O=t(10),L=t(4506),D=t(980),B=t(2206),M=t(243),q=t(3316),W=t(3712),J=t(2447),F=t(5443),X=t(787),Z=t(7584),H=t(6441),G=t(1716);let K=[{id:1,name:"Hot Springs SD",label:"Hot Springs Travel Plaza"},{id:2,name:"Pierre SD",label:"Pierre Fuel & More"},{id:3,name:"Rapid City SD",label:"Rapid City Express"},{id:4,name:"Sioux Falls SD",label:"Sioux Falls SuperStop"},{id:5,name:"Watertown SD",label:"Watertown Travel Center"},{id:6,name:"Aberdeen SD",label:"Aberdeen Quick Stop"},{id:7,name:"Brookings SD",label:"Brookings Fuel Plaza"}],Q=[{id:"1",email:"manager@hotsprings.com",full_name:"Sarah Johnson",role:"manager",auth_provider:"local",site_ids:[1],created_at:"2024-01-15",is_active:!0},{id:"2",email:"tech@pierre.com",full_name:"Mike Wilson",role:"technician",auth_provider:"local",site_ids:[2],created_at:"2024-02-20",is_active:!0},{id:"3",email:"admin@corporate.com",full_name:"Jennifer Adams",role:"admin",auth_provider:"microsoft",site_ids:[1,2,3,4,5,6,7],created_at:"2024-01-01",is_active:!0}];var V=(0,G.c2)(()=>{let{isOpen:e,onOpen:r,onClose:t}=(0,n.q)(),[G,V]=(0,i.useState)(!1),[Y,$]=(0,i.useState)(null),[ee,er]=(0,i.useState)(null),[et,es]=(0,i.useState)(Q),[ei,en]=(0,i.useState)({email:"",password:"",confirmPassword:"",full_name:"",role:"technician",site_ids:[]}),ea=(0,a.ff)("white","gray.800"),eo=(0,a.ff)("gray.200","gray.600"),el=async()=>{if(!ei.email||!ei.password||!ei.full_name){$("Please fill in all required fields");return}if(ei.password!==ei.confirmPassword){$("Passwords do not match");return}if(0===ei.site_ids.length){$("Please select at least one site");return}V(!0),$(null);try{let{user:e,error:r}=await H.Pj.createLocalAccount({email:ei.email,password:ei.password,full_name:ei.full_name,role:ei.role,site_ids:ei.site_ids});r?$(r.message):e&&(er("User ".concat(ei.email," created successfully")),en({email:"",password:"",confirmPassword:"",full_name:"",role:"technician",site_ids:[]}),t())}catch(e){$("Failed to create user")}finally{V(!1)}},ec=e=>e.map(e=>{var r;return null===(r=K.find(r=>r.id===e))||void 0===r?void 0:r.name}).filter(Boolean).join(", "),ed=e=>{switch(e){case"admin":return"purple";case"manager":return"blue";case"technician":return"green";default:return"gray"}};return(0,s.jsxs)(o.W,{maxW:"7xl",py:8,children:[(0,s.jsxs)(l.g,{spacing:6,align:"stretch",children:[(0,s.jsxs)(c.U,{justify:"space-between",children:[(0,s.jsxs)(d.x,{children:[(0,s.jsx)(h.X,{size:"lg",color:"brand.500",children:"User Management"}),(0,s.jsx)(u.x,{color:"gray.500",mt:1,children:"Manage local accounts and site access permissions"})]}),(0,s.jsx)(p.z,{leftIcon:(0,s.jsx)(Z.Z,{className:"w-4 h-4"}),colorScheme:"brand",onClick:r,children:"Create Local Account"})]}),Y&&(0,s.jsxs)(m.b,{status:"error",borderRadius:"md",children:[(0,s.jsx)(f.z,{}),Y]}),ee&&(0,s.jsxs)(m.b,{status:"success",borderRadius:"md",children:[(0,s.jsx)(f.z,{}),ee]}),(0,s.jsxs)(g.Z,{bg:ea,borderColor:eo,borderWidth:"1px",children:[(0,s.jsx)(x.O,{children:(0,s.jsx)(u.x,{fontSize:"lg",fontWeight:"semibold",children:"All Users"})}),(0,s.jsx)(j.e,{children:(0,s.jsxs)(_.i,{variant:"simple",children:[(0,s.jsx)(v.h,{children:(0,s.jsxs)(S.Tr,{children:[(0,s.jsx)(w.Th,{children:"User"}),(0,s.jsx)(w.Th,{children:"Role"}),(0,s.jsx)(w.Th,{children:"Auth Provider"}),(0,s.jsx)(w.Th,{children:"Sites"}),(0,s.jsx)(w.Th,{children:"Created"}),(0,s.jsx)(w.Th,{children:"Status"}),(0,s.jsx)(w.Th,{children:"Actions"})]})}),(0,s.jsx)(y.p,{children:et.map(e=>(0,s.jsxs)(S.Tr,{children:[(0,s.jsx)(C.Td,{children:(0,s.jsxs)(l.g,{align:"start",spacing:1,children:[(0,s.jsx)(u.x,{fontWeight:"medium",children:e.full_name}),(0,s.jsx)(u.x,{fontSize:"sm",color:"gray.500",children:e.email})]})}),(0,s.jsx)(C.Td,{children:(0,s.jsx)(T.C,{colorScheme:ed(e.role),children:e.role.toUpperCase()})}),(0,s.jsx)(C.Td,{children:(0,s.jsx)(T.C,{variant:"outline",colorScheme:"microsoft"===e.auth_provider?"blue":"gray",children:e.auth_provider})}),(0,s.jsx)(C.Td,{children:(0,s.jsx)(u.x,{fontSize:"sm",children:ec(e.site_ids)})}),(0,s.jsx)(C.Td,{children:(0,s.jsx)(u.x,{fontSize:"sm",children:new Date(e.created_at).toLocaleDateString()})}),(0,s.jsx)(C.Td,{children:(0,s.jsx)(T.C,{colorScheme:e.is_active?"green":"red",children:e.is_active?"Active":"Inactive"})}),(0,s.jsx)(C.Td,{children:(0,s.jsxs)(U.v,{children:[(0,s.jsx)(b.j,{as:P.h,icon:(0,s.jsx)(X.Z,{className:"w-4 h-4"}),variant:"ghost",size:"sm"}),(0,s.jsxs)(I.q,{children:[(0,s.jsx)(k.s,{children:"Edit User"}),(0,s.jsx)(k.s,{children:"Reset Password"}),(0,s.jsx)(k.s,{children:"Manage Sites"}),(0,s.jsx)(k.s,{color:"red.500",children:"Deactivate"})]})]})})]},e.id))})]})})]})]}),(0,s.jsxs)(A.u_,{isOpen:e,onClose:t,size:"lg",children:[(0,s.jsx)(E.Z,{}),(0,s.jsxs)(N.h,{children:[(0,s.jsx)(z.x,{children:"Create Local Account"}),(0,s.jsx)(R.o,{}),(0,s.jsx)(O.f,{children:(0,s.jsxs)(l.g,{spacing:4,children:[(0,s.jsxs)(L.NI,{isRequired:!0,children:[(0,s.jsx)(D.l,{children:"Full Name"}),(0,s.jsx)(B.I,{value:ei.full_name,onChange:e=>en({...ei,full_name:e.target.value}),placeholder:"Enter full name"})]}),(0,s.jsxs)(L.NI,{isRequired:!0,children:[(0,s.jsx)(D.l,{children:"Email"}),(0,s.jsx)(B.I,{type:"email",value:ei.email,onChange:e=>en({...ei,email:e.target.value}),placeholder:"Enter email address"})]}),(0,s.jsxs)(L.NI,{isRequired:!0,children:[(0,s.jsx)(D.l,{children:"Password"}),(0,s.jsx)(B.I,{type:"password",value:ei.password,onChange:e=>en({...ei,password:e.target.value}),placeholder:"Enter password"})]}),(0,s.jsxs)(L.NI,{isRequired:!0,children:[(0,s.jsx)(D.l,{children:"Confirm Password"}),(0,s.jsx)(B.I,{type:"password",value:ei.confirmPassword,onChange:e=>en({...ei,confirmPassword:e.target.value}),placeholder:"Confirm password"})]}),(0,s.jsxs)(L.NI,{isRequired:!0,children:[(0,s.jsx)(D.l,{children:"Role"}),(0,s.jsxs)(M.P,{value:ei.role,onChange:e=>en({...ei,role:e.target.value}),children:[(0,s.jsx)("option",{value:"viewer",children:"Viewer"}),(0,s.jsx)("option",{value:"technician",children:"Technician"}),(0,s.jsx)("option",{value:"manager",children:"Manager"})]})]}),(0,s.jsxs)(L.NI,{isRequired:!0,children:[(0,s.jsx)(D.l,{children:"Site Access"}),(0,s.jsx)(q.c,{value:ei.site_ids.map(String),onChange:e=>en({...ei,site_ids:e.map(Number)}),children:(0,s.jsx)(W.K,{spacing:2,children:K.map(e=>(0,s.jsx)(J.X,{value:String(e.id),children:e.label},e.id))})})]})]})}),(0,s.jsxs)(F.m,{children:[(0,s.jsx)(p.z,{variant:"ghost",mr:3,onClick:t,children:"Cancel"}),(0,s.jsx)(p.z,{colorScheme:"brand",onClick:el,isLoading:G,loadingText:"Creating...",children:"Create User"})]})]})]})]})}),Y=()=>(0,s.jsx)(V,{})}},function(e){e.O(0,[237,287,436,774,888,179],function(){return e(e.s=577)}),_N_E=e.O()}]);