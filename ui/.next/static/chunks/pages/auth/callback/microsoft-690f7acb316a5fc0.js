(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[487],{5708:function(e,t,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/auth/callback/microsoft",function(){return r(2726)}])},6441:function(e,t,r){"use strict";r.d(t,{Pj:function(){return o}});var n=r(4155);let i={clientId:n.env.NEXT_PUBLIC_AZURE_CLIENT_ID||"",tenantId:n.env.NEXT_PUBLIC_AZURE_TENANT_ID||"common",redirectUri:n.env.NEXT_PUBLIC_AZURE_REDIRECT_URI||"".concat(window.location.origin,"/auth/callback/microsoft"),scopes:["openid","profile","email","User.Read"]},o=new class{async initializeSession(){try{let e=localStorage.getItem("opsgraph_token");if(e){let t=await this.validateToken(e);t?this.setCurrentUser(t):localStorage.removeItem("opsgraph_token")}}catch(e){console.error("Session initialization failed:",e)}}async validateToken(e){try{let t=await fetch("/api/auth/validate",{method:"GET",headers:{Authorization:"Bearer ".concat(e),"Content-Type":"application/json"}});if(t.ok)return await t.json();return null}catch(e){return console.error("Token validation failed:",e),null}}setCurrentUser(e){this.currentUser=e,this.authStateListeners.forEach(t=>t(e)),e&&this.setSessionContext(e.id)}async setSessionContext(e){try{await fetch("/api/auth/session-context",{method:"POST",headers:{Authorization:"Bearer ".concat(localStorage.getItem("opsgraph_token")),"Content-Type":"application/json"},body:JSON.stringify({userId:e})})}catch(e){console.error("Failed to set session context:",e)}}async signInWithMicrosoft(){try{let e=this.buildMicrosoftAuthUrl();return window.location.href=e,{user:null,error:null}}catch(e){return{user:null,error:e}}}buildMicrosoftAuthUrl(){let e=new URLSearchParams({client_id:i.clientId,response_type:"code",redirect_uri:i.redirectUri,scope:i.scopes.join(" "),response_mode:"query",state:crypto.randomUUID()});return"https://login.microsoftonline.com/".concat(i.tenantId,"/oauth2/v2.0/authorize?").concat(e)}async handleMicrosoftCallback(e,t){try{let r=await fetch("/api/auth/microsoft/callback",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:e,state:t})});if(!r.ok)throw Error("Microsoft login failed");let n=await r.json(),i=n.user;return localStorage.setItem("opsgraph_token",n.access_token),this.setCurrentUser(i),{user:i,error:null}}catch(e){return{user:null,error:e}}}async signInWithLocal(e,t){try{let r=await fetch("/api/auth/local/signin",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:t})});if(!r.ok){let e=await r.json();throw Error(e.message||"Login failed")}let n=await r.json(),i=n.user;return localStorage.setItem("opsgraph_token",n.access_token),this.setCurrentUser(i),{user:i,error:null}}catch(e){return{user:null,error:e}}}async createLocalAccount(e){try{let t=await fetch("/api/auth/local/create",{method:"POST",headers:{Authorization:"Bearer ".concat(localStorage.getItem("opsgraph_token")),"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok){let e=await t.json();throw Error(e.message||"Account creation failed")}let r=await t.json();return{user:r.user,error:null}}catch(e){return{user:null,error:e}}}async signOut(){try{return await fetch("/api/auth/signout",{method:"POST",headers:{Authorization:"Bearer ".concat(localStorage.getItem("opsgraph_token")),"Content-Type":"application/json"}}),localStorage.removeItem("opsgraph_token"),this.setCurrentUser(null),{error:null}}catch(e){return localStorage.removeItem("opsgraph_token"),this.setCurrentUser(null),{error:e}}}async getUser(){return this.currentUser}async getProfile(e){var t;return(null===(t=this.currentUser)||void 0===t?void 0:t.profile)||null}async updateProfile(e,t){try{var r;let n=await fetch("/api/users/".concat(e,"/profile"),{method:"PATCH",headers:{Authorization:"Bearer ".concat(localStorage.getItem("opsgraph_token")),"Content-Type":"application/json"},body:JSON.stringify(t)});if(!n.ok)throw Error("Profile update failed");return(null===(r=this.currentUser)||void 0===r?void 0:r.profile)&&(this.currentUser.profile={...this.currentUser.profile,...t},this.setCurrentUser(this.currentUser)),{error:null}}catch(e){return{error:e}}}async getCurrentSession(){try{return{user:this.currentUser,error:null}}catch(e){return{user:null,error:e}}}onAuthStateChange(e){return this.authStateListeners.push(e),()=>{let t=this.authStateListeners.indexOf(e);t>-1&&this.authStateListeners.splice(t,1)}}async canAccessSite(e){var t;let r=null===(t=this.currentUser)||void 0===t?void 0:t.profile;return!!r&&(!!r.is_admin||"admin"===r.role||r.site_ids.includes(e))}async getUserSites(){var e;let t=null===(e=this.currentUser)||void 0===e?void 0:e.profile;return(null==t?void 0:t.site_ids)||[]}async hasAdminAccess(){var e;let t=null===(e=this.currentUser)||void 0===e?void 0:e.profile;return(null==t?void 0:t.is_admin)||(null==t?void 0:t.role)==="admin"||!1}async resetPassword(e){try{let t=await fetch("/api/auth/local/reset-password",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e})});if(!t.ok)throw Error("Password reset failed");return{error:null}}catch(e){return{error:e}}}async changePassword(e,t){try{let r=await fetch("/api/auth/local/change-password",{method:"POST",headers:{Authorization:"Bearer ".concat(localStorage.getItem("opsgraph_token")),"Content-Type":"application/json"},body:JSON.stringify({currentPassword:e,newPassword:t})});if(!r.ok)throw Error("Password change failed");return{error:null}}catch(e){return{error:e}}}constructor(){this.currentUser=null,this.authStateListeners=[],this.initializeSession()}}},2726:function(e,t,r){"use strict";r.r(t);var n=r(5893),i=r(7294),o=r(1163),a=r(6254),s=r(8186),c=r(8899),l=r(92),u=r(6657),d=r(8843),h=r(8491),f=r(6441);t.default=()=>{let e=(0,o.useRouter)(),[t,r]=(0,i.useState)(!0),[p,m]=(0,i.useState)(null);return((0,i.useEffect)(()=>{let t=async()=>{try{let{code:t,state:n,error:i}=e.query;if(i){m("Authentication failed: ".concat(i)),r(!1);return}if(!t||!n){m("Missing authentication parameters"),r(!1);return}let{user:o,error:a}=await f.Pj.handleMicrosoftCallback(t,n);a?m(a.message):o?e.push("/dashboard"):m("Authentication failed - no user returned")}catch(e){m("An unexpected error occurred during authentication")}finally{r(!1)}};e.isReady&&t()},[e.isReady,e.query]),t)?(0,n.jsx)(a.W,{maxW:"md",centerContent:!0,py:20,children:(0,n.jsxs)(s.g,{spacing:6,children:[(0,n.jsx)(c.$,{size:"xl",color:"blue.500"}),(0,n.jsx)(l.x,{children:"Processing Microsoft login..."})]})}):p?(0,n.jsx)(a.W,{maxW:"md",centerContent:!0,py:20,children:(0,n.jsxs)(s.g,{spacing:6,children:[(0,n.jsxs)(u.b,{status:"error",borderRadius:"md",children:[(0,n.jsx)(d.z,{}),p]}),(0,n.jsx)(h.z,{colorScheme:"blue",onClick:()=>e.push("/login"),children:"Back to Login"})]})}):(0,n.jsx)(a.W,{maxW:"md",centerContent:!0,py:20,children:(0,n.jsx)(s.g,{spacing:6,children:(0,n.jsx)(l.x,{children:"Redirecting..."})})})}},1163:function(e,t,r){e.exports=r(6885)},4155:function(e){var t,r,n,i=e.exports={};function o(){throw Error("setTimeout has not been defined")}function a(){throw Error("clearTimeout has not been defined")}function s(e){if(t===setTimeout)return setTimeout(e,0);if((t===o||!t)&&setTimeout)return t=setTimeout,setTimeout(e,0);try{return t(e,0)}catch(r){try{return t.call(null,e,0)}catch(r){return t.call(this,e,0)}}}!function(){try{t="function"==typeof setTimeout?setTimeout:o}catch(e){t=o}try{r="function"==typeof clearTimeout?clearTimeout:a}catch(e){r=a}}();var c=[],l=!1,u=-1;function d(){l&&n&&(l=!1,n.length?c=n.concat(c):u=-1,c.length&&h())}function h(){if(!l){var e=s(d);l=!0;for(var t=c.length;t;){for(n=c,c=[];++u<t;)n&&n[u].run();u=-1,t=c.length}n=null,l=!1,function(e){if(r===clearTimeout)return clearTimeout(e);if((r===a||!r)&&clearTimeout)return r=clearTimeout,clearTimeout(e);try{r(e)}catch(t){try{return r.call(null,e)}catch(t){return r.call(this,e)}}}(e)}}function f(e,t){this.fun=e,this.array=t}function p(){}i.nextTick=function(e){var t=Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)t[r-1]=arguments[r];c.push(new f(e,t)),1!==c.length||l||s(h)},f.prototype.run=function(){this.fun.apply(null,this.array)},i.title="browser",i.browser=!0,i.env={},i.argv=[],i.version="",i.versions={},i.on=p,i.addListener=p,i.once=p,i.off=p,i.removeListener=p,i.removeAllListeners=p,i.emit=p,i.prependListener=p,i.prependOnceListener=p,i.listeners=function(e){return[]},i.binding=function(e){throw Error("process.binding is not supported")},i.cwd=function(){return"/"},i.chdir=function(e){throw Error("process.chdir is not supported")},i.umask=function(){return 0}},9062:function(e,t,r){"use strict";r.d(t,{lq:function(){return i},qq:function(){return o}});var n=r(7294);function i(...e){return t=>{e.forEach(e=>{!function(e,t){if(null!=e){if("function"==typeof e){e(t);return}try{e.current=t}catch(r){throw Error(`Cannot assign value '${t}' to ref '${e}'`)}}}(e,t)})}}function o(...e){return(0,n.useMemo)(()=>i(...e),e)}},8491:function(e,t,r){"use strict";r.d(t,{z:function(){return v}});var n=r(5893),i=r(9062),o=r(5544),a=r(397),s=r(4926),c=r(7294),l=r(2110);let[u,d]=(0,l.k)({strict:!1,name:"ButtonGroupContext"});var h=r(7430);function f(e){let{children:t,className:r,...i}=e,o=(0,c.isValidElement)(t)?(0,c.cloneElement)(t,{"aria-hidden":!0,focusable:!1}):t,a=(0,s.cx)("chakra-button__icon",r);return(0,n.jsx)(h.m.span,{display:"inline-flex",alignSelf:"center",flexShrink:0,...i,className:a,children:o})}f.displayName="ButtonIcon";var p=r(3695),m=r(8899);function y(e){let{label:t,placement:r,spacing:i="0.5rem",children:o=(0,n.jsx)(m.$,{color:"currentColor",width:"1em",height:"1em"}),className:a,__css:l,...u}=e,d=(0,s.cx)("chakra-button__spinner",a),f="start"===r?"marginEnd":"marginStart",y=(0,c.useMemo)(()=>(0,p.k0)({display:"flex",alignItems:"center",position:t?"relative":"absolute",[f]:t?i:0,fontSize:"1em",lineHeight:"normal",...l}),[l,t,f,i]);return(0,n.jsx)(h.m.div,{className:d,...u,__css:y,children:o})}y.displayName="ButtonSpinner";var g=r(9381),x=r(9653);let v=(0,g.G)((e,t)=>{let r=d(),l=(0,x.m)("Button",{...r,...e}),{isDisabled:u=r?.isDisabled,isLoading:f,isActive:p,children:m,leftIcon:g,rightIcon:v,loadingText:k,iconSpacing:j="0.5rem",type:w,spinner:S,spinnerPlacement:b="start",className:T,as:C,shouldWrapChildren:E,...N}=(0,o.L)(e),U=(0,c.useMemo)(()=>{let e={...l?._focus,zIndex:1};return{display:"inline-flex",appearance:"none",alignItems:"center",justifyContent:"center",userSelect:"none",position:"relative",whiteSpace:"nowrap",verticalAlign:"middle",outline:"none",...l,...!!r&&{_focus:e}}},[l,r]),{ref:I,type:A}=function(e){let[t,r]=(0,c.useState)(!e),n=(0,c.useCallback)(e=>{e&&r("BUTTON"===e.tagName)},[]);return{ref:n,type:t?"button":void 0}}(C),P={rightIcon:v,leftIcon:g,iconSpacing:j,children:m,shouldWrapChildren:E};return(0,n.jsxs)(h.m.button,{disabled:u||f,ref:(0,i.qq)(t,I),as:C,type:w??A,"data-active":(0,a.P)(p),"data-loading":(0,a.P)(f),__css:U,className:(0,s.cx)("chakra-button",T),...N,children:[f&&"start"===b&&(0,n.jsx)(y,{className:"chakra-button__spinner--start",label:k,placement:"start",spacing:j,children:S}),f?k||(0,n.jsx)(h.m.span,{opacity:0,children:(0,n.jsx)(_,{...P})}):(0,n.jsx)(_,{...P}),f&&"end"===b&&(0,n.jsx)(y,{className:"chakra-button__spinner--end",label:k,placement:"end",spacing:j,children:S})]})});function _(e){let{leftIcon:t,rightIcon:r,children:i,iconSpacing:o,shouldWrapChildren:a}=e;return a?(0,n.jsxs)("span",{style:{display:"contents"},children:[t&&(0,n.jsx)(f,{marginEnd:o,children:t}),i,r&&(0,n.jsx)(f,{marginStart:o,children:r})]}):(0,n.jsxs)(n.Fragment,{children:[t&&(0,n.jsx)(f,{marginEnd:o,children:t}),i,r&&(0,n.jsx)(f,{marginStart:o,children:r})]})}v.displayName="Button"},6254:function(e,t,r){"use strict";r.d(t,{W:function(){return l}});var n=r(5893),i=r(5544),o=r(4926),a=r(9381),s=r(9653),c=r(7430);let l=(0,a.G)(function(e,t){let{className:r,centerContent:a,...l}=(0,i.L)(e),u=(0,s.m)("Container",e);return(0,n.jsx)(c.m.div,{ref:t,className:(0,o.cx)("chakra-container",r),...l,__css:{...u,...a&&{display:"flex",flexDirection:"column",alignItems:"center"}}})});l.displayName="Container"},3712:function(e,t,r){"use strict";r.d(t,{K:function(){return d}});var n=r(5893),i=r(911),o=r(4926),a=r(7294),s=r(7430);let c=e=>(0,n.jsx)(s.m.div,{className:"chakra-stack__item",...e,__css:{display:"inline-block",flex:"0 0 auto",minWidth:0,...e.__css}});c.displayName="StackItem";var l=r(1185),u=r(9381);let d=(0,u.G)((e,t)=>{let{isInline:r,direction:u,align:d,justify:h,spacing:f="0.5rem",wrap:p,children:m,divider:y,className:g,shouldWrapChildren:x,...v}=e,_=r?"row":u??"column",k=(0,a.useMemo)(()=>(function(e){let{spacing:t,direction:r}=e,n={column:{my:t,mx:0,borderLeftWidth:0,borderBottomWidth:"1px"},"column-reverse":{my:t,mx:0,borderLeftWidth:0,borderBottomWidth:"1px"},row:{mx:t,my:0,borderLeftWidth:"1px",borderBottomWidth:0},"row-reverse":{mx:t,my:0,borderLeftWidth:"1px",borderBottomWidth:0}};return{"&":(0,l.XQ)(r,e=>n[e])}})({spacing:f,direction:_}),[f,_]),j=!!y,w=!x&&!j,S=(0,a.useMemo)(()=>{let e=(0,i.W)(m);return w?e:e.map((t,r)=>{let i=void 0!==t.key?t.key:r,o=r+1===e.length,s=(0,n.jsx)(c,{children:t},i),l=x?s:t;if(!j)return l;let u=(0,a.cloneElement)(y,{__css:k});return(0,n.jsxs)(a.Fragment,{children:[l,o?null:u]},i)})},[y,k,j,w,x,m]),b=(0,o.cx)("chakra-stack",g);return(0,n.jsx)(s.m.div,{ref:t,display:"flex",alignItems:d,justifyContent:h,flexDirection:_,flexWrap:p,gap:j?void 0:f,className:b,...v,children:S})});d.displayName="Stack"},8186:function(e,t,r){"use strict";r.d(t,{g:function(){return a}});var n=r(5893),i=r(3712),o=r(9381);let a=(0,o.G)((e,t)=>(0,n.jsx)(i.K,{align:"center",...e,direction:"column",ref:t}));a.displayName="VStack"},92:function(e,t,r){"use strict";r.d(t,{x:function(){return u}});var n=r(5893),i=r(5544),o=r(7155),a=r(4926),s=r(9381),c=r(9653),l=r(7430);let u=(0,s.G)(function(e,t){let r=(0,c.m)("Text",e),{className:s,align:u,decoration:d,casing:h,...f}=(0,i.L)(e),p=(0,o.o)({textAlign:e.align,textDecoration:e.decoration,textTransform:e.casing});return(0,n.jsx)(l.m.p,{ref:t,className:(0,a.cx)("chakra-text",e.className),...p,...f,__css:r})});u.displayName="Text"},397:function(e,t,r){"use strict";r.d(t,{P:function(){return n},Q:function(){return i}});let n=e=>e?"":void 0,i=e=>!!e||void 0},911:function(e,t,r){"use strict";r.d(t,{W:function(){return i}});var n=r(7294);function i(e){return n.Children.toArray(e).filter(e=>(0,n.isValidElement)(e))}},1185:function(e,t,r){"use strict";r.d(t,{AV:function(){return i},XQ:function(){return o},Yq:function(){return a}});var n=r(9115);let i=Object.freeze(["base","sm","md","lg","xl","2xl"]);function o(e,t){return Array.isArray(e)?e.map(e=>null===e?null:t(e)):(0,n.Kn)(e)?Object.keys(e).reduce((r,n)=>(r[n]=t(e[n]),r),{}):null!=e?t(e):null}function a(e,t=i){let r={};return e.forEach((e,n)=>{let i=t[n];null!=e&&(r[i]=e)}),r}}},function(e){e.O(0,[774,888,179],function(){return e(e.s=5708)}),_N_E=e.O()}]);